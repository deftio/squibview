{"version":3,"file":"html-to-markdown.js","sources":["../src/HtmlToMarkdown.js"],"sourcesContent":["import TurndownService from 'turndown';\n\n/**\n * Converts HTML content to Markdown format using the Turndown library with \n * customizations specific to SquibView's needs.\n */\nexport default class HtmlToMarkdown {\n  constructor(options = {}) {\n    this.turndownService = new TurndownService({\n      headingStyle: 'atx',       // Use # style headings\n      codeBlockStyle: 'fenced',  // Use ``` style code blocks\n      emDelimiter: '*',          // Use * for emphasis\n      bulletListMarker: '-',     // Use - for bullet lists\n      ...options\n    });\n    \n    // Add a simple cache for converted content to improve performance\n    this.cache = new Map();\n    this.cacheSize = options.cacheSize || 10;\n    \n    // Store special blocks for preservation\n    this._specialBlocks = new Map();\n    \n    this.configureTurndownRules();\n  }\n  \n  /**\n   * Configure custom Turndown rules\n   */\n  configureTurndownRules() {\n    // Preserve Mermaid diagram blocks with special identifiers\n    this.turndownService.addRule('mermaid', {\n      filter: node => {\n        return node.nodeName === 'DIV' && \n               node.classList.contains('mermaid');\n      },\n      replacement: (content, node) => {\n        // Generate a unique ID for this mermaid block to help with matching later\n        const blockId = 'mermaid_' + Math.random().toString(36).substring(2, 10);\n        \n        // Store the raw content for later use\n        if (this._specialBlocks) {\n          this._specialBlocks.set(blockId, {\n            type: 'mermaid',\n            content: node.textContent\n          });\n        }\n        \n        // Return with special marker that can be identified later\n        return `\\n<div data-special-block=\"${blockId}\" class=\"mermaid\">\\n` +\n               node.textContent + \n               `\\n</div>\\n`;\n      }\n    });\n    \n    // Preserve SVG elements with special identifiers\n    this.turndownService.addRule('svg', {\n      filter: 'svg',\n      replacement: (content, node) => {\n        // Generate a unique ID for this SVG block\n        const blockId = 'svg_' + Math.random().toString(36).substring(2, 10);\n        \n        // Store the raw SVG for later use\n        const serializer = new XMLSerializer();\n        const svgString = serializer.serializeToString(node);\n        \n        if (this._specialBlocks) {\n          this._specialBlocks.set(blockId, {\n            type: 'svg',\n            content: svgString\n          });\n        }\n        \n        // Return with special marker\n        return `\\n<div data-special-block=\"${blockId}\" class=\"svg-container\">\\n` +\n               svgString + \n               `\\n</div>\\n`;\n      }\n    });\n    \n    // Preserve GeoJSON map blocks\n    this.turndownService.addRule('geojson', {\n      filter: node => {\n        return node.nodeName === 'DIV' && \n               node.classList.contains('geojson-map');\n      },\n      replacement: (content, node) => {\n        // Generate a unique ID for this GeoJSON block\n        const blockId = 'geojson_' + Math.random().toString(36).substring(2, 10);\n        \n        // Try to extract the GeoJSON data from the script element\n        let geojsonContent = '';\n        try {\n          // The actual GeoJSON would be in a script tag or in a data attribute\n          // Here we'll use a placeholder since the actual data is hard to extract\n          geojsonContent = node.dataset.geojson || '{\"type\":\"FeatureCollection\",\"features\":[]}';\n        } catch(e) {\n          console.error('Error extracting GeoJSON data:', e);\n        }\n        \n        if (this._specialBlocks) {\n          this._specialBlocks.set(blockId, {\n            type: 'geojson',\n            content: geojsonContent\n          });\n        }\n        \n        return `\\n<div data-special-block=\"${blockId}\" class=\"geojson-container\">\\n` +\n               geojsonContent + \n               `\\n</div>\\n`;\n      }\n    });\n    \n    // Preserve Math blocks\n    this.turndownService.addRule('math', {\n      filter: node => {\n        return node.nodeName === 'DIV' && \n               node.classList.contains('math-display');\n      },\n      replacement: (content, node) => {\n        // Generate a unique ID for this math block\n        const blockId = 'math_' + Math.random().toString(36).substring(2, 10);\n        \n        // Get the raw math content (might be wrapped in $$...$$ in the original)\n        let mathContent = node.textContent;\n        \n        // Remove $$ delimiters if present\n        mathContent = mathContent.replace(/^\\$\\$([\\s\\S]*)\\$\\$$/, '$1');\n        \n        if (this._specialBlocks) {\n          this._specialBlocks.set(blockId, {\n            type: 'math',\n            content: mathContent\n          });\n        }\n        \n        return `\\n<div data-special-block=\"${blockId}\" class=\"math-container\">\\n` +\n               mathContent + \n               `\\n</div>\\n`;\n      }\n    });\n    \n    // Special handling for code blocks\n    this.turndownService.addRule('codeBlock', {\n      filter: node => {\n        return node.nodeName === 'PRE' && \n               node.firstChild && \n               node.firstChild.nodeName === 'CODE';\n      },\n      replacement: (content, node) => {\n        const code = node.firstChild.textContent;\n        let language = '';\n        \n        // Try to detect language from class\n        if (node.firstChild.className) {\n          const match = node.firstChild.className.match(/language-(\\w+)/);\n          if (match) {\n            language = match[1];\n          }\n        }\n        \n        return '\\n```' + language + '\\n' + code.trim() + '\\n```\\n';\n      }\n    });\n    \n    // Improve table handling\n    this.turndownService.addRule('tableCell', {\n      filter: ['th', 'td'],\n      replacement: (content, node) => {\n        return ' ' + content.trim() + ' |';\n      }\n    });\n    \n    this.turndownService.addRule('tableRow', {\n      filter: 'tr',\n      replacement: (content, node) => {\n        let prefix = '|';\n        \n        // Handle header rows\n        if (node.parentNode.nodeName === 'THEAD') {\n          const cells = node.querySelectorAll('th, td').length;\n          const separatorRow = '\\n|' + ' --- |'.repeat(cells);\n          return prefix + content + separatorRow;\n        }\n        \n        return prefix + content + '\\n';\n      }\n    });\n    \n    this.turndownService.addRule('table', {\n      filter: 'table',\n      replacement: (content, node) => {\n        // If the table doesn't have a header row, we need to add the separator\n        if (!node.querySelector('thead') && node.querySelector('tr')) {\n          const firstRow = node.querySelector('tr');\n          const cells = firstRow.querySelectorAll('th, td').length;\n          const separator = '\\n|' + ' --- |'.repeat(cells) + '\\n';\n          \n          // Insert separator after the first row\n          const rows = content.split('\\n');\n          if (rows.length > 0) {\n            return rows[0] + separator + rows.slice(1).join('\\n') + '\\n\\n';\n          }\n        }\n        \n        return content + '\\n\\n';\n      }\n    });\n  }\n  \n  /**\n   * Get a simplified hash code of a string for caching\n   * \n   * @private\n   * @param {string} str - The string to hash\n   * @returns {string} A hash representation of the string\n   */\n  _getStringHash(str) {\n    // Simple and fast hash function for strings\n    // This is not a cryptographic hash, just for caching purposes\n    let hash = 0;\n    for (let i = 0; i < str.length; i++) {\n      const char = str.charCodeAt(i);\n      hash = ((hash << 5) - hash) + char;\n      hash = hash & hash; // Convert to 32bit integer\n    }\n    return hash.toString(36); // Convert to base36 for shorter string\n  }\n  \n  /**\n   * Convert HTML to Markdown with caching for performance\n   * \n   * @param {string} html - The HTML content to convert\n   * @param {Object} options - Additional options\n   * @param {string} options.originalSource - The original source if available\n   * @returns {string} The converted Markdown content\n   */\n  convert(html, options = {}) {\n    // Clear special blocks map for this conversion\n    this._specialBlocks.clear();\n    \n    // Use a hash of the HTML as the cache key\n    const cacheKey = this._getStringHash(html);\n    \n    // Check if we have a cached version\n    if (this.cache.has(cacheKey)) {\n      return this.cache.get(cacheKey);\n    }\n    \n    // Convert the HTML to Markdown\n    let markdown = this.turndownService.turndown(html);\n    \n    // Post-process the markdown to restore special blocks\n    markdown = this._postProcessMarkdown(markdown, options.originalSource);\n    \n    // Cache the result\n    this.cache.set(cacheKey, markdown);\n    \n    // Keep the cache size under control\n    if (this.cache.size > this.cacheSize) {\n      // Remove the oldest entry\n      const firstKey = this.cache.keys().next().value;\n      this.cache.delete(firstKey);\n    }\n    \n    return markdown;\n  }\n  \n  /**\n   * Post-process markdown to restore special blocks and apply additional formatting\n   * \n   * @private\n   * @param {string} markdown - The converted markdown \n   * @param {string} originalSource - The original markdown source if available\n   * @returns {string} - The processed markdown\n   */\n  _postProcessMarkdown(markdown, originalSource) {\n    // First pass: Convert the special blocks markers back to proper markdown\n    \n    // Convert mermaid blocks\n    const mermaidBlockRegex = /<div data-special-block=\"mermaid_[^\"]*\" class=\"mermaid\">\\s*([\\s\\S]*?)\\s*<\\/div>/g;\n    markdown = markdown.replace(mermaidBlockRegex, (match, content) => {\n      return `\\n\\`\\`\\`mermaid\\n${content.trim()}\\n\\`\\`\\`\\n`;\n    });\n    \n    // Convert SVG blocks\n    const svgBlockRegex = /<div data-special-block=\"svg_[^\"]*\" class=\"svg-container\">\\s*([\\s\\S]*?)\\s*<\\/div>/g;\n    markdown = markdown.replace(svgBlockRegex, (match, content) => {\n      // Try to find a closing SVG tag\n      const svgMatch = content.match(/<svg[\\s\\S]*?<\\/svg>/);\n      if (svgMatch) {\n        return `\\n\\`\\`\\`svg\\n${svgMatch[0]}\\n\\`\\`\\`\\n`;\n      }\n      return match;\n    });\n    \n    // Convert GeoJSON blocks\n    const geojsonBlockRegex = /<div data-special-block=\"geojson_[^\"]*\" class=\"geojson-container\">\\s*([\\s\\S]*?)\\s*<\\/div>/g;\n    markdown = markdown.replace(geojsonBlockRegex, (match, content) => {\n      try {\n        // Ensure content is valid JSON before creating the code block\n        JSON.parse(content);\n        return `\\n\\`\\`\\`geojson\\n${content.trim()}\\n\\`\\`\\`\\n`;\n      } catch (e) {\n        console.error('Invalid GeoJSON data:', e);\n        return `\\n\\`\\`\\`geojson\\n{\"type\":\"FeatureCollection\",\"features\":[]}\\n\\`\\`\\`\\n`;\n      }\n    });\n    \n    // Convert Math blocks\n    const mathBlockRegex = /<div data-special-block=\"math_[^\"]*\" class=\"math-container\">\\s*([\\s\\S]*?)\\s*<\\/div>/g;\n    markdown = markdown.replace(mathBlockRegex, (match, content) => {\n      return `\\n\\`\\`\\`math\\n${content.trim()}\\n\\`\\`\\`\\n`;\n    });\n    \n    // Second pass: Restore blocks from original source if possible\n    if (originalSource) {\n      // Extract code blocks from original source\n      const codeBlockRegex = /```(\\w+)\\s*([\\s\\S]*?)```/g;\n      let match;\n      let blockIndex = 0;\n      const originalBlocks = [];\n      \n      while ((match = codeBlockRegex.exec(originalSource)) !== null) {\n        const type = match[1];\n        const content = match[2];\n        \n        if (type === 'mermaid' || type === 'svg' || type === 'geojson' || type === 'math') {\n          originalBlocks.push({\n            type,\n            content: match[0],\n            index: blockIndex++\n          });\n        }\n      }\n      \n      // Try to match original blocks with current blocks\n      // This is a simplistic approach that assumes blocks are in the same order\n      \n      let mermaidIndex = 0;\n      let svgIndex = 0;\n      let geojsonIndex = 0;\n      let mathIndex = 0;\n      \n      // Replace mermaid blocks\n      markdown = markdown.replace(/```mermaid\\s*([\\s\\S]*?)```/g, (match, content) => {\n        const mermaidBlocks = originalBlocks.filter(b => b.type === 'mermaid');\n        if (mermaidIndex < mermaidBlocks.length) {\n          return mermaidBlocks[mermaidIndex++].content;\n        }\n        return match;\n      });\n      \n      // Replace SVG blocks\n      markdown = markdown.replace(/```svg\\s*([\\s\\S]*?)```/g, (match, content) => {\n        const svgBlocks = originalBlocks.filter(b => b.type === 'svg');\n        if (svgIndex < svgBlocks.length) {\n          return svgBlocks[svgIndex++].content;\n        }\n        return match;\n      });\n      \n      // Replace GeoJSON blocks\n      markdown = markdown.replace(/```geojson\\s*([\\s\\S]*?)```/g, (match, content) => {\n        const geojsonBlocks = originalBlocks.filter(b => b.type === 'geojson');\n        if (geojsonIndex < geojsonBlocks.length) {\n          return geojsonBlocks[geojsonIndex++].content;\n        }\n        return match;\n      });\n      \n      // Replace Math blocks\n      markdown = markdown.replace(/```math\\s*([\\s\\S]*?)```/g, (match, content) => {\n        const mathBlocks = originalBlocks.filter(b => b.type === 'math');\n        if (mathIndex < mathBlocks.length) {\n          return mathBlocks[mathIndex++].content;\n        }\n        return match;\n      });\n    }\n    \n    return markdown;\n  }\n}"],"names":["HtmlToMarkdown","options","arguments","length","undefined","_classCallCheck","turndownService","TurndownService","_objectSpread","headingStyle","codeBlockStyle","emDelimiter","bulletListMarker","cache","Map","cacheSize","_specialBlocks","configureTurndownRules","_createClass","key","value","_this","addRule","filter","node","nodeName","classList","contains","replacement","content","blockId","Math","random","toString","substring","set","type","textContent","concat","serializer","XMLSerializer","svgString","serializeToString","geojsonContent","dataset","geojson","e","console","error","mathContent","replace","firstChild","code","language","className","match","trim","prefix","parentNode","cells","querySelectorAll","separatorRow","repeat","querySelector","firstRow","separator","rows","split","slice","join","_getStringHash","str","hash","i","char","charCodeAt","convert","html","clear","cacheKey","has","get","markdown","turndown","_postProcessMarkdown","originalSource","size","firstKey","keys","next","mermaidBlockRegex","svgBlockRegex","svgMatch","geojsonBlockRegex","JSON","parse","mathBlockRegex","codeBlockRegex","blockIndex","originalBlocks","exec","push","index","mermaidIndex","svgIndex","geojsonIndex","mathIndex","mermaidBlocks","b","svgBlocks","geojsonBlocks","mathBlocks"],"mappings":"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"}