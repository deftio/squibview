import e from"turndown";function t(e,t,r){return t&&function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,a(n.key),n)}}(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function r(e,t,r){return(t=a(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function n(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function a(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t);if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e,"string");return"symbol"==typeof t?t:t+""}var o=function(){return t((function t(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.turndownService=new e(function(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?n(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):n(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}({headingStyle:"atx",codeBlockStyle:"fenced",emDelimiter:"*",bulletListMarker:"-"},a)),this.cache=new Map,this.cacheSize=a.cacheSize||10,this._specialBlocks=new Map,this.configureTurndownRules()}),[{key:"configureTurndownRules",value:function(){var e=this;this.turndownService.addRule("squibviewFencedBlock",{filter:function(e){return"DIV"===e.nodeName&&e.hasAttribute("data-source-type")},replacement:function(t,r,n){var a=r.getAttribute("data-source-type")||"code",o="";switch(a){case"mermaid":case"math":var c=r.innerHTML;c=c.replace(/<br\s*\/?>/gi,"\n");var i=r.ownerDocument.createElement("div");i.innerHTML=c,o=i.textContent||i.innerText||"";break;case"geojson":case"topojson":case"stl":r.hasAttribute("data-original-source")?o=r.getAttribute("data-original-source"):r.textContent&&r.textContent.trim()?o=r.textContent:(console.warn("[HtmlToMarkdown] Missing original data for",a,"block"),o="Error: Original data lost during rendering");break;case"svg":o=r.hasAttribute("data-original-source")?r.getAttribute("data-original-source"):r.innerHTML;break;case"csv":case"tsv":case"psv":var l=r.querySelector("table");l?o=e._htmlTableToDelimitedText(l,a):(o="Error: Table not found for "+a,console.warn('Could not find table inside div[data-source-type="'+a+'"]'));break;default:var s=r.querySelector("pre");if(s)o=(s.querySelector("code")||s).textContent;else o=r.textContent,console.warn('Could not find <pre> inside div[data-source-type="'+a+'"]')}var u="code"===a?"":a,d=o.trim();return"\n```"+u+(d=d?"\n"+d+"\n":"\n")+"```\n"}}),this.turndownService.addRule("keepImageTags",{filter:"img",replacement:function(e,t){return t.outerHTML}}),this.turndownService.addRule("mermaid",{filter:function(e){return"DIV"===e.nodeName&&e.classList.contains("mermaid")},replacement:function(t,r){var n="mermaid_"+Math.random().toString(36).substring(2,10);return e._specialBlocks&&e._specialBlocks.set(n,{type:"mermaid",content:r.textContent}),'\n<div data-special-block="'.concat(n,'" class="mermaid">\n')+r.textContent+"\n</div>\n"}}),this.turndownService.addRule("geojson",{filter:function(e){return"DIV"===e.nodeName&&e.classList.contains("geojson-map")},replacement:function(t,r){var n="geojson_"+Math.random().toString(36).substring(2,10),a="";try{a=r.dataset.geojson||'{"type":"FeatureCollection","features":[]}'}catch(e){console.error("Error extracting GeoJSON data:",e)}return e._specialBlocks&&e._specialBlocks.set(n,{type:"geojson",content:a}),'\n<div data-special-block="'.concat(n,'" class="geojson-container">\n')+a+"\n</div>\n"}}),this.turndownService.addRule("math",{filter:function(e){return"DIV"===e.nodeName&&e.classList.contains("math-display")},replacement:function(t,r){var n="math_"+Math.random().toString(36).substring(2,10),a=r.textContent;return a=a.replace(/^\$\$([\s\S]*)\$\$$/,"$1"),e._specialBlocks&&e._specialBlocks.set(n,{type:"math",content:a}),'\n<div data-special-block="'.concat(n,'" class="math-container">\n')+a+"\n</div>\n"}}),this.turndownService.addRule("codeBlock",{filter:function(e){return"PRE"===e.nodeName&&e.firstChild&&"CODE"===e.firstChild.nodeName},replacement:function(e,t){var r=t.firstChild.textContent,n="";if(t.firstChild.className){var a=t.firstChild.className.match(/language-(\w+)/);a&&(n=a[1])}return"\n```"+n+"\n"+r.trim()+"\n```\n"}}),this.turndownService.addRule("tableCell",{filter:["th","td"],replacement:function(e,t){return" "+e.trim()+" |"}}),this.turndownService.addRule("tableRow",{filter:"tr",replacement:function(e,t){if("THEAD"===t.parentNode.nodeName){var r=t.querySelectorAll("th, td").length;return"|"+e+("\n|"+" --- |".repeat(r))}return"|"+e+"\n"}}),this.turndownService.addRule("table",{filter:"table",replacement:function(t,r){if(r.parentElement&&r.parentElement.hasAttribute("data-source-type")){var n=r.parentElement.getAttribute("data-source-type");if("csv"===n||"tsv"===n||"psv"===n)return t}var a="",o=r.querySelector("thead tr");return o&&(a+="|",o.querySelectorAll("th").forEach((function(t){a+=" ".concat(e.turndownService.turndown(t.innerHTML).trim()," |")})),a+="\n|",o.querySelectorAll("th").forEach((function(){a+=" --- |"})),a+="\n"),r.querySelectorAll("tbody tr").forEach((function(t){a+="|",t.querySelectorAll("td").forEach((function(t){a+=" ".concat(e.turndownService.turndown(t.innerHTML).trim()," |")})),a+="\n"})),"\n"+a+"\n"}}),this.turndownService.keep(["li"]),this.turndownService.addRule("taskListItems",{filter:function(e){return"LI"===e.nodeName&&e.firstChild&&"INPUT"===e.firstChild.nodeName&&"checkbox"===e.firstChild.type},replacement:function(e,t){for(var r=t.firstChild,n=r.checked,a="",o=r.nextSibling;o;)a+=o.outerHTML||o.textContent,o=o.nextSibling;return(n?"[x] ":"[ ] ")+this.turndownService.turndown(a).trim()}})}},{key:"_getStringHash",value:function(e){for(var t=0,r=0;r<e.length;r++){t=(t<<5)-t+e.charCodeAt(r),t|=0}return t.toString(36)}},{key:"convert",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this._specialBlocks.clear(),this._placeholders=[];var r=this._getStringHash(e);if(this.cache.has(r))return this.cache.get(r);var n=this._preProcessSpecialContainers(e),a=this.turndownService.turndown(n);if(a=this._postProcessMarkdown(a,t.originalSource),this.cache.set(r,a),this.cache.size>this.cacheSize){var o=this.cache.keys().next().value;this.cache.delete(o)}return a}},{key:"_preProcessSpecialContainers",value:function(e){var t,r=this;if("undefined"==typeof document||!document.createElement)return console.warn("Document not available, skipping pre-processing"),this._placeholders=[],e;try{if((t=document.createElement("div")).innerHTML=e,"function"!=typeof t.querySelector)throw new Error("querySelector not available")}catch(t){return console.warn("DOM methods not available, using regex fallback for pre-processing"),this._regexFallbackPreProcess(e)}var n=t.querySelectorAll("div[data-source-type]"),a=[];return n.forEach((function(e,t){var n,o=e.getAttribute("data-source-type"),c="__SPECIAL_CONTAINER_".concat(t,"__");if("svg"===o&&e.hasAttribute("data-original-source"))n=e.getAttribute("data-original-source");else if(["mermaid","math","geojson","topojson","stl"].includes(o)&&e.hasAttribute("data-original-source"))n=e.getAttribute("data-original-source");else if("csv"===o||"tsv"===o||"psv"===o){var i=e.querySelector("table");n=i?r._htmlTableToDelimitedText(i,o):"Error: Table not found for "+o}else{var l=e.querySelector("pre");if(l)n=(l.querySelector("code")||l).textContent.replace(/^[\r\n]+|[\r\n]+$/g,"");else n=e.textContent.replace(/^[\r\n]+|[\r\n]+$/g,"")}a.push({placeholder:c,type:o,content:n});var s=document.createTextNode(c);e.parentNode&&e.parentNode.replaceChild(s,e)})),this._placeholders=a,t.innerHTML}},{key:"_postProcessMarkdown",value:function(e,t){this._placeholders&&this._placeholders.length>0&&this._placeholders.forEach((function(t){var r=t.placeholder,n=t.type,a="code"===n?"":n,o=t.content.replace(/^[\r\n]+|[\r\n]+$/g,""),c="```".concat(a,"\n").concat(o,"\n```"),i=r,l=i.replace(/_/g,"\\_");e.includes(i)?e=e.replace(i,c):e.includes(l)&&(e=e.replace(l,c))}));e=(e=e.replace(/<div data-special-block="mermaid_[^"]*" class="mermaid">\s*([\s\S]*?)\s*<\/div>/g,(function(e,t){return"\n```mermaid\n".concat(t.trim(),"\n```\n")}))).replace(/<div data-special-block="svg_[^"]*" class="svg-container">\s*([\s\S]*?)\s*<\/div>/g,(function(e,t){var r=t.match(/<svg[\s\S]*?<\/svg>/);return r?"\n```svg\n".concat(r[0],"\n```\n"):e}));if(e=(e=e.replace(/<div data-special-block="geojson_[^"]*" class="geojson-container">\s*([\s\S]*?)\s*<\/div>/g,(function(e,t){try{return JSON.parse(t),"\n```geojson\n".concat(t.trim(),"\n```\n")}catch(e){return console.error("Invalid GeoJSON data:",e),'\n```geojson\n{"type":"FeatureCollection","features":[]}\n```\n'}}))).replace(/<div data-special-block="math_[^"]*" class="math-container">\s*([\s\S]*?)\s*<\/div>/g,(function(e,t){return"\n```math\n".concat(t.trim(),"\n```\n")})),t){for(var r,n=/```(\w+)\s*([\s\S]*?)```/g,a=0,o=[];null!==(r=n.exec(t));){var c=r[1];r[2],"mermaid"!==c&&"svg"!==c&&"geojson"!==c&&"topojson"!==c&&"stl"!==c&&"math"!==c||o.push({type:c,content:r[0],index:a++})}var i=0,l=0,s=0,u=0;e=e.replace(/```mermaid\s*([\s\S]*?)```/g,(function(e,t){var r=o.filter((function(e){return"mermaid"===e.type}));return i<r.length?r[i++].content:e})),e=e.replace(/```svg\s*([\s\S]*?)```/g,(function(e,t){var r=o.filter((function(e){return"svg"===e.type}));return l<r.length?r[l++].content:e})),e=e.replace(/```geojson\s*([\s\S]*?)```/g,(function(e,t){var r=o.filter((function(e){return"geojson"===e.type}));return s<r.length?r[s++].content:e}));var d=0;e=e.replace(/```topojson\s*([\s\S]*?)```/g,(function(e,t){var r=o.filter((function(e){return"topojson"===e.type}));return d<r.length?r[d++].content:e}));var p=0;e=e.replace(/```stl\s*([\s\S]*?)```/g,(function(e,t){var r=o.filter((function(e){return"stl"===e.type}));return p<r.length?r[p++].content:e})),e=e.replace(/```math\s*([\s\S]*?)```/g,(function(e,t){var r=o.filter((function(e){return"math"===e.type}));return u<r.length?r[u++].content:e}))}return e}},{key:"_htmlTableToDelimitedText",value:function(e,t){var r;switch(t){case"csv":default:r=",";break;case"tsv":r="\t";break;case"psv":r="|"}var n=[];if(!e||"function"!=typeof e.querySelectorAll)return console.warn("DOM methods not available for table extraction, using regex fallback"),this._extractTableDataFromHtml(e?e.outerHTML||e.innerHTML||String(e):"",t);var a=e.querySelectorAll("tr");return a&&"function"==typeof a.forEach?(a.forEach((function(e){var t=[];e.querySelectorAll("th, td").forEach((function(e){var n=e.textContent||"";n=n.replace(/\r?\n|\r/g," ").trim(),","===r&&n.includes(",")&&(n='"'.concat(n.replace(/"/g,'""'),'"')),t.push(n)})),n.push(t.join(r))})),n.join("\n")):(console.warn("querySelectorAll did not return proper NodeList, falling back to regex"),this._extractTableDataFromHtml(e.outerHTML||e.innerHTML||String(e),t))}},{key:"_extractTableDataFromHtml",value:function(e,t){var r;switch(t){case"csv":default:r=",";break;case"tsv":r="\t";break;case"psv":r="|"}try{for(var n,a=/<tr[^>]*>([\s\S]*?)<\/tr>/gi,o=[];null!==(n=a.exec(e));){for(var c=n[1],i=/<(?:th|td)[^>]*>([\s\S]*?)<\/(?:th|td)>/gi,l=[],s=void 0;null!==(s=i.exec(c));){var u=s[1];u=u.replace(/<[^>]*>/g,"").replace(/&quot;/g,'"').replace(/&#x27;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/\r?\n|\r/g," ").trim(),","===r&&u.includes(",")&&(u='"'.concat(u.replace(/"/g,'""'),'"')),l.push(u)}l.length>0&&o.push(l.join(r))}return o.join("\n")}catch(e){return console.error("Error extracting table data from HTML:",e),"Error: Could not extract table data"}}},{key:"_regexFallbackPreProcess",value:function(e){var t=this,r=[],n=0,a=e.replace(/<div[^>]*data-source-type="([^"]*)"[^>]*>([\s\S]*?)<\/div>/g,(function(e,a,o){var c,i="__SPECIAL_CONTAINER_".concat(n,"__");if("svg"===a){var l=e.match(/data-original-source="([^"]*)"/);if(l)c=l[1].replace(/&quot;/g,'"').replace(/&#x27;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&");else{var s=o.match(/<svg[\s\S]*?<\/svg>/);c=s?s[0]:o}}else if("csv"===a||"tsv"===a||"psv"===a)c=t._extractTableDataFromHtml(o,a);else{var u=o.match(/<pre[^>]*><code[^>]*>([\s\S]*?)<\/code><\/pre>/);c=u?u[1].replace(/<span[^>]*>/g,"").replace(/<\/span>/g,"").replace(/&quot;/g,'"').replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&"):o.replace(/<[^>]*>/g,"").replace(/&quot;/g,'"').replace(/&#x27;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&")}return r.push({placeholder:i,type:a,content:c}),n++,"<p>".concat(i,"</p>")}));return this._placeholders=r,a}}])}();export{o as default};
//# sourceMappingURL=html-to-markdown.min.js.map
