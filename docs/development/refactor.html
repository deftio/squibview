<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SquibView Refactoring Plan</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; viewBox=&#39;0 0 32 32&#39;&gt;&lt;circle cx=&#39;16&#39; cy=&#39;16&#39; r=&#39;14&#39; fill=&#39;%23f57c00&#39; stroke=&#39;%23000&#39; stroke-width=&#39;1&#39;/&gt;&lt;path d=&#39;M2 16h28M16 2a14 14 0 0114 14 14 14 0 01-14 14 14 14 0 01-14-14A14 14 0 0116 2zm0 0v28M9 16a7 7 0 0014 0 7 7 0 00-14 0z&#39; fill=&#39;none&#39; stroke=&#39;%23000&#39; stroke-width=&#39;1&#39;/&gt;&lt;/svg&gt;">
  <style>


/* Additional CSS */
/* SquibView CLI Generated Styles */
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
  line-height: 1.6;
  color: #333;
  max-width: 900px;
  margin: 0 auto;
  padding: 2rem 3rem;
  background-color: #fff;
}

h1, h2, h3, h4, h5, h6 {
  margin-top: 1.5em;
  margin-bottom: 0.5em;
  font-weight: 600;
  line-height: 1.25;
}

h1 { 
  font-size: 2rem;
  
}
h2 { 
  font-size: 1.5rem;
  
}
h3 { font-size: 1.25rem; }
h4 { font-size: 1rem; }
h5 { font-size: 0.875rem; }
h6 { font-size: 0.85rem; color: #666; }

p { margin-bottom: 1rem; }

a {
  color: #0066cc;
  text-decoration: none;
}

a:hover {
  color: #0066cc;
  text-decoration: underline;
}

ul, ol {
  margin-bottom: 1rem;
  padding-left: 2rem;
}

li {
  margin-bottom: 0.25rem;
}

blockquote {
  margin: 1rem 0;
  padding: 0.5rem 1rem;
  border-left: 4px solid #ddd;
  background-color: #f9f9f9;
  color: #666;
}

code {
  background-color: #f5f5f5;
  padding: 0.2em 0.4em;
  border-radius: 3px;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 0.85em;
}

pre {
  background-color: #f8f8f8;
  padding: 1rem;
  margin-bottom: 1rem;
  overflow-x: auto;
  border-radius: 4px;
}

pre code {
  background-color: transparent;
  padding: 0;
  border-radius: 0;
}

table {
  border-collapse: collapse;
  width: 100%;
  margin-bottom: 1rem;
}

th, td {
  border: 1px solid #ddd;
  padding: 0.5rem;
  text-align: left;
}

th {
  background-color: #f2f2f2;
  font-weight: bold;
}

img {
  max-width: 100%;
  height: auto;
  margin-bottom: 1rem;
}

hr {
  border: none;
  border-top: 1px solid #ddd;
  margin: 2rem 0;
}

/* Badge images - inline display */
p img {
  display: inline;
  margin: 0 2px;
  vertical-align: middle;
}

/* Math styling */
.MathJax {
  overflow-x: auto;
  overflow-y: hidden;
}

/* Responsive design */
@media (max-width: 768px) {
  body {
    padding: 1rem 1.5rem;
  }
  
  table {
    font-size: 0.875rem;
  }
  
  th, td {
    padding: 0.25rem;
  }
}

/* Print styles */
@media print {
  body {
    padding: 0;
    color: #000;
  }
  
  a {
    color: #000;
    text-decoration: underline;
  }
  
  pre, blockquote {
    page-break-inside: avoid;
  }
  
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
}
  </style>
    <!-- Highlight.js for syntax highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <!-- Leaflet for GeoJSON/TopoJSON maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/topojson-client@3.1.0/dist/topojson-client.min.js"></script>
  <!-- Three.js for STL 3D models -->
  <script src="https://unpkg.com/three@0.171.0/build/three.min.js"></script>
  <!-- MathJax for math rendering -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        ignoreHtmlClass: 'tex2jax_ignore',
        processHtmlClass: 'tex2jax_process'
      },
      svg: {
        fontCache: 'global'
      }
    };
  </script>
  <script type="text/javascript" id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
  </script>
  <!-- Mermaid for diagram rendering -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
</head>
<body>
<div><h1>SquibView Refactoring Plan</h1><h2>1. Intent and Purpose of SquibView</h2><p>SquibView is designed as a <strong>headless, embeddable JavaScript component</strong> for 2-way editing and live rendering of various content types. Its core functionality allows users to edit content in either a source view or a rendered WYSIWYG-like view, with changes in one view instantly reflected in the other.</p><p><strong>Key Capabilities:</strong></p><ul><li><strong>Multi-Format Handling:</strong> Natively supports GitHub-Flavored Markdown, HTML, and provides a plugin architecture for additional formats (e.g., CSV, TSV).</li><li><strong>Rich Content Rendering:</strong><ul><li>Mermaid diagrams for complex visualizations.</li><li>Inline SVG graphics.</li><li>Syntax-highlighted code blocks.</li><li>Mathematical expressions (e.g., via MathJax or KaTeX if integrated).</li><li>Well-formatted tables.</li></ul></li><li><strong>Headless by Design:</strong> Offers a rich programmatic API for all its functionalities, allowing deep integration into various applications.</li><li><strong>Optional Basic Controls:</strong> Provides a simple, activatable set of UI controls for users needing a quick start or basic editing interface.</li><li><strong>Robust Editing Features:</strong><ul><li>Comprehensive Undo/Redo functionality via a <code>RevisionManager</code>.</li><li>Cross-platform copy-paste support, intelligently handling rich content.</li></ul></li><li><strong>Versatile Environment Support:</strong><ul><li>Works seamlessly in pure JavaScript (via script tags), ESM (ES Modules), and UMD (Universal Module Definition) environments.</li><li>Provides wrappers/examples for popular frameworks like React (with potential for Vue, Svelte, etc.).</li></ul></li><li><strong>Standalone Builds:</strong> Offers builds with all dependencies bundled, enabling usage in non-web-centric environments (e.g., Python applications needing a UI component for rendering/editing) via web view wrappers.</li><li><strong>Customization:</strong><ul><li>Resizable to fit various container dimensions.</li><li>CSS themable for full visual customization.</li></ul></li></ul><p>The primary goal is to provide a flexible, powerful, and easy-to-integrate solution for live content editing and rendering across diverse web development scenarios and even beyond traditional web pages.</p><h2>2. Refactoring Goals for Enhanced Maintainability</h2><p>The following areas are targeted for review and potential refactoring to improve long-term maintainability, code clarity, testability, and reduce coupling.</p><hr><h3>2.1. Code Structure &amp; Modularity (Within <code>src/squibview.js</code> and Project)</h3><p><strong>A. <code>SquibView</code> Class Responsibilities &amp; Potential Extractions:</strong></p><ul><li><strong>Current State:</strong> The <code>SquibView</code> class orchestrates most of the editor’s functionality.</li><li><strong>Potential Improvement:</strong> Identify cohesive sets of functionality within <code>SquibView</code> that could be extracted into smaller, more focused helper classes or modules.
<ul><li><strong>DOM Management (<code>DOMManager</code>/<code>UIManager</code>):</strong><ul><li><strong>Responsibility:</strong><code>createStructure</code>, <code>adjustLayout</code>, direct DOM manipulations for main editor panels.</li><li><strong>Benefit:</strong> Decouples core logic from specific DOM construction details, improves testability of DOM logic.</li></ul></li><li><strong>Renderer Management (<code>RendererRegistry</code>/<code>ContentTypeManager</code>):</strong><ul><li><strong>Responsibility:</strong><code>registerRenderer</code>, <code>registerDefaultRenderers</code>, <code>renderOutput</code>, logic for switching between and invoking renderers.</li><li><strong>Benefit:</strong> Centralizes content type handling, makes adding new renderers cleaner.</li></ul></li><li><strong>Clipboard Operations (<code>ClipboardManager</code>):</strong><ul><li><strong>Responsibility:</strong><code>copySource</code>, <code>copyHTML</code>, <code>copyToClipboard</code>, SVG to PNG conversion, image to data URL for clipboard.</li><li><strong>Benefit:</strong> Isolates complex clipboard logic, easier to manage platform quirks.</li></ul></li><li><strong>Selection API (<code>SelectionManager</code>):</strong><ul><li><strong>Responsibility:</strong><code>onTextSelected</code>, <code>replaceSelectedText</code>, <code>getCurrentSelection</code>, <code>clearSelection</code>, <code>setSelectionEditable</code>, <code>toggleSelectionLock</code>.</li><li><strong>Benefit:</strong> Consolidates selection-related logic, potentially simplifying interaction with both source and output views.</li></ul></li><li><strong>Core Layout CSS Injection (if adopted):</strong><ul><li><strong>Responsibility:</strong> Logic to inject a minimal set of CSS rules for fundamental panel layout and visibility into the document head on first instantiation. This ensures structural integrity even if the main <code>squibview.css</code> is missing or altered.</li><li><strong>Benefit:</strong> Guarantees “works out of the box” structural behavior. Reduces reliance on external CSS for core layout.</li></ul></li></ul></li><li><strong>Benefit:</strong> Smaller, more focused classes are easier to understand, test, and maintain. Reduces the cognitive load of the main <code>SquibView</code> class.</li><li><strong>Effort/Priority:</strong> Medium-High (significant structural change but high impact).</li></ul><p><strong>B. File Granularity:</strong></p><ul><li><strong>Current State:</strong> Most core logic is in <code>src/squibview.js</code>.</li><li><strong>Potential Improvement:</strong><ul><li>Move pure utility functions to <code>src/utils.js</code>.</li><li>Consider moving default renderer logic (if complex) to separate files (e.g., <code>src/renderers/markdown_renderer.js</code>).</li><li>If JS-injecting core CSS, the CSS string could be in <code>src/core-layout.css.js</code>.</li></ul></li><li><strong>Benefit:</strong> Better organization, <code>squibview.js</code> becomes more of an orchestrator.</li><li><strong>Effort/Priority:</strong> Low-Medium.</li></ul><hr><h3>2.2. State Management</h3><ul><li><strong>Current State:</strong> State is managed via class properties and options.</li><li><strong>Potential Improvement:</strong> Formally document all key state variables, their purpose, and how they are updated. Ensure a clear distinction between initial options and internal dynamic state.</li><li><strong>Benefit:</strong> Improved clarity and predictability of component behavior.</li><li><strong>Effort/Priority:</strong> Low (primarily documentation and review).</li></ul><hr><h3>2.3. Configuration and Options (<code>defaultOptions</code>)</h3><ul><li><strong>Current State:</strong><code>defaultOptions</code> are defined.</li><li><strong>Potential Improvement:</strong> Add basic validation or warnings for invalid option values/types during <code>SquibView</code> instantiation to aid developer integration.</li><li><strong>Benefit:</strong> Better developer experience, quicker debugging of integration issues.</li><li><strong>Effort/Priority:</strong> Low-Medium.</li></ul><hr><h3>2.4. API Design (Public Methods &amp; Events)</h3><ul><li><strong>Current State:</strong> A rich API exists. <code>TinyEmitter</code> is used for events.</li><li><strong>Potential Improvement:</strong> Review API for consistency in naming and parameters. Identify if more events would be beneficial for extensibility (e.g., before/after view change, before/after content set).</li><li><strong>Benefit:</strong> Enhanced developer experience and greater flexibility for plugin development.</li><li><strong>Effort/Priority:</strong> Medium.</li></ul><hr><h3>2.5. Asynchronous Operations</h3><ul><li><strong>Current State:</strong><code>async/await</code> is used for operations like rendering and copying.</li><li><strong>Potential Improvement:</strong> Ensure UI clearly reflects busy/loading states for any longer async operations. Double-check error handling in all async call chains.</li><li><strong>Benefit:</strong> Improved user experience and robustness.</li><li><strong>Effort/Priority:</strong> Low-Medium.</li></ul><hr><h3>2.6. Error Handling</h3><ul><li><strong>Current State:</strong> Some specific error handling exists (e.g., Mermaid).</li><li><strong>Potential Improvement:</strong> Systematically review error handling for:
<ul><li>Graceful error catching in event handlers, rendering, API calls.</li><li>Consistent reporting (<code>console.warn</code> or custom error events).</li><li>Ensuring internal errors don’t break the entire editor.</li></ul></li><li><strong>Benefit:</strong> Increased stability and easier debugging.</li><li><strong>Effort/Priority:</strong> Medium.</li></ul><hr><h3>2.7. Build Process &amp; Environment-Specific Builds</h3><ul><li><strong>Current State:</strong> Rollup config manages multiple build outputs (ESM, UMD, Standalone, React).</li><li><strong>Potential Improvement:</strong><ul><li>Thoroughly comment <code>rollup.config.js</code> sections.</li><li>Review <code>external</code> and <code>globals</code> settings for each build to ensure correctness and minimize bundle sizes where appropriate.</li><li>Ensure React wrapper (<code>SquibViewReact.js</code>) follows best practices for props, state, effects, and synchronization with the <code>SquibView</code> instance. Look for potential race conditions or inefficient re-renders.</li></ul></li><li><strong>Benefit:</strong> More reliable builds, easier maintenance of the build process, robust framework integration.</li><li><strong>Effort/Priority:</strong> Medium.</li></ul><hr><h3>2.8. Testing Strategy</h3><ul><li><strong>Current State:</strong> Jest for unit/integration, Puppeteer for E2E.</li><li><strong>Potential Improvement:</strong><ul><li>Increase unit test coverage, especially for newly extracted modules/classes.</li><li>Add more integration tests for complex interactions (e.g., renderer plugins, advanced clipboard scenarios).</li><li>Expand E2E tests to cover all example pages and build types systematically.</li><li>Focus on making tests less brittle and easier to maintain.</li></ul></li><li><strong>Benefit:</strong> Higher confidence in code quality, easier to catch regressions.</li><li><strong>Effort/Priority:</strong> Ongoing, Medium-High.</li></ul><hr><h3>2.9. Documentation (Code, User-Facing, Examples)</h3><ul><li><strong>Current State:</strong> JSDoc, <code>README.md</code>, Programmer’s Guide, examples exist.</li><li><strong>Potential Improvement:</strong><ul><li>Ensure JSDoc is comprehensive for all public APIs and complex internal functions.</li><li>Update Programmer’s Guide with any architectural changes from refactoring.</li><li>Add more examples for specific advanced use cases or plugin development.</li></ul></li><li><strong>Benefit:</strong> Easier for developers to use and contribute to SquibView.</li><li><strong>Effort/Priority:</strong> Ongoing, Medium.</li></ul><hr><h3>2.10. CSS Strategy: Core Layout vs. Theming</h3><ul><li><strong>Current State:</strong><code>squibview.css</code> handles both layout and theming, recently refactored to use CSS custom properties.</li><li><strong>Decision Point from Discussion:</strong><ul><li><strong>Option 1 (JS-driven core layout - Inline Styles):</strong> Fundamental layout styles (flex containers, panel visibility) are applied directly by JavaScript as inline styles. <code>squibview.css</code> focuses on theming these elements and styling their content.</li><li><strong>Option 2 (JS-driven core layout - Injected Classes):</strong> JavaScript injects a <code>&lt;style&gt;</code> block with minimal core layout CSS classes on first instantiation. JS then adds/removes these classes. <code>squibview.css</code> themes using these classes and CSS variables.</li></ul></li><li><strong>Chosen Direction (To be confirmed, leaning towards Option 2):</strong> Define a minimal set of CSS classes for core panel structure (flex properties, visibility) and have JS ensure these classes and their definitions are present (e.g., by injecting a style tag if necessary on first load). The main <code>squibview.css</code> file would then primarily provide the theming (colors, padding, borders, fonts using CSS variables) and styles for non-structural elements.</li><li><strong>Benefit:</strong> Ensures SquibView is structurally sound “out of the box” even if <code>squibview.css</code> is not loaded or is modified incorrectly. Clearer separation of concerns for CSS.</li><li><strong>Effort/Priority:</strong> Medium.</li></ul></div>
  <script>
    // Initialize MathJax after page load
    document.addEventListener('DOMContentLoaded', function() {
      if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise().catch(function(err) {
          console.warn('MathJax typesetting failed:', err);
        });
      }
    });
  </script>
  <script>
    // Initialize Mermaid after page load
    document.addEventListener('DOMContentLoaded', function() {
      if (window.mermaid) {
        try {
          window.mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose',
            fontFamily: 'inherit'
          });
          
          // Manually render all mermaid diagrams
          const mermaidElements = document.querySelectorAll('.mermaid');
          mermaidElements.forEach(function(element, index) {
            const id = 'mermaid-' + index;
            element.id = id;
            try {
              window.mermaid.render(id + '-svg', element.textContent, function(svgCode) {
                element.innerHTML = svgCode;
              });
            } catch (err) {
              console.warn('Mermaid rendering failed for element', index, ':', err);
              // Fallback: show the text content
              element.innerHTML = '<pre>' + element.textContent + '</pre>';
            }
          });
        } catch (err) {
          console.warn('Mermaid initialization failed:', err);
        }
      }
    });
  </script>
</body>
</html>