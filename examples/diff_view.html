<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SquibView - Diff View Demo</title>  
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><circle cx='16' cy='16' r='14' fill='%23f57c00' stroke='%23000' stroke-width='1'/><path d='M2 16h28M16 2a14 14 0 0114 14 14 14 0 01-14 14a14 14 0 01-14-14A14 14 0 0116 2zm0 0v28M9 16a7 7 0 0014 0a7 7 0 00-14 0z' fill='none' stroke='%23000' stroke-width='1'/></svg>">

  <link rel="stylesheet" href="../dist/squibview.css">

  <!-- External libraries for the lean UMD build -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    .demo-container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .demo-section {
      margin-bottom: 40px;
      padding: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background: #fafafa;
    }
    
    .demo-section h2 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #2a57d3;
      padding-bottom: 10px;
    }
    
    .controls {
      margin: 15px 0;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .controls button {
      background: #2a57d3;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .controls button:hover {
      background: #1e3f8f;
    }
    
    .controls button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .controls select {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .editor-container {
      height: 400px;
      margin: 15px 0;
    }
    
    .diff-container {
      margin: 15px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
      max-height: 500px;
      overflow: auto;
    }
    
    .api-demo {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      padding: 15px;
      margin: 15px 0;
    }
    
    .api-demo pre {
      background: #2d3748;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      margin: 10px 0;
      font-size: 12px;
    }
    
    .revision-info {
      font-size: 12px;
      color: #666;
      margin: 10px 0;
      padding: 8px;
      background: #f0f0f0;
      border-radius: 4px;
    }
  </style>
</head>

<body>
  <div class="demo-container">
    <h1>SquibView Diff View Demo</h1>
    <div id="version-info" style="background: #f0f0f0; padding: 10px; border-radius: 4px; margin: 10px 0; font-size: 14px; color: #666;">
      Loading version info...
    </div>
    <p>This demo showcases the diff view functionality that allows you to compare different revisions of your content.</p>
    
    <!-- Basic Example -->
    <div class="demo-section">
      <h2>Basic Diff View</h2>
      <p>Make some edits to see the diff between revisions. The diff will show when you click "Show Diff".</p>
      
      <div class="editor-container">
        <div id="editor1"></div>
      </div>
      
      <div class="controls">
        <button id="showDiff1">Show Current vs Previous</button>
        <button id="clearDiff1">Clear Diff</button>
        <button id="addContent1">Add Sample Content</button>
      </div>
      
      <div class="revision-info" id="revisionInfo1"></div>
      <div class="diff-container" id="diffView1"></div>
    </div>
    
    <!-- Custom Styling Example -->
    <div class="demo-section">
      <h2>Custom Styled Diff</h2>
      <p>Same functionality but with custom CSS classes for different styling.</p>
      
      <div class="editor-container">
        <div id="editor2"></div>
      </div>
      
      <div class="controls">
        <button id="showDiff2">Show Custom Styled Diff</button>
        <button id="clearDiff2">Clear Diff</button>
        <label>
          <input type="checkbox" id="lineNumbers2" checked> Show Line Numbers
        </label>
      </div>
      
      <div class="diff-container" id="diffView2"></div>
    </div>
    
    <!-- Revision Selection Example -->
    <div class="demo-section">
      <h2>Compare Specific Revisions</h2>
      <p>Select any two revisions to compare. Make several edits first to have multiple revisions.</p>
      
      <div class="editor-container">
        <div id="editor3"></div>
      </div>
      
      <div class="controls">
        <span>From:</span>
        <select id="fromRevision"></select>
        <span>To:</span>
        <select id="toRevision"></select>
        <button id="compareDiff">Compare Revisions</button>
        <button id="populateRevisions">Make Sample Revisions</button>
      </div>
      
      <div class="diff-container" id="diffView3"></div>
    </div>
    
    <!-- Programmatic API Example -->
    <div class="demo-section">
      <h2>Programmatic API</h2>
      <p>Access diff data programmatically for integration with your application.</p>
      
      <div class="editor-container">
        <div id="editor4"></div>
      </div>
      
      <div class="controls">
        <button id="getDiffData">Get Diff Object</button>
        <button id="getDiffHTML">Get Diff HTML</button>
        <button id="makeChanges4">Make Changes</button>
      </div>
      
      <div class="api-demo">
        <strong>API Response:</strong>
        <pre id="diffData"></pre>
      </div>
    </div>
    
    <!-- Events Example -->
    <div class="demo-section">
      <h2>Event Handling</h2>
      <p>Listen for diff-related events to integrate with your application workflow.</p>
      
      <div class="editor-container">
        <div id="editor5"></div>
      </div>
      
      <div class="controls">
        <button id="showDiff5">Show Diff (with Events)</button>
        <button id="clearEvents">Clear Event Log</button>
      </div>
      
      <div class="api-demo">
        <strong>Event Log:</strong>
        <pre id="eventLog"></pre>
      </div>
      
      <div class="diff-container" id="diffView5"></div>
    </div>
  </div>

  <script type="module">
    // Fix global variable name mapping for lean UMD build
    if (typeof window.markdownit !== 'undefined') {
      window.MarkdownIt = window.markdownit;
    }
    
    // Load SquibView UMD build
    const script = document.createElement('script');
    script.src = '../dist/squibview.umd.min.js';
    script.onload = function() {
      initializeDemos();
    };
    document.head.appendChild(script);
    
    function initializeDemos() {
      // Display version info
      document.getElementById('version-info').innerHTML = 
        `SquibView Version: ${SquibView.version.version} | Repository: <a href="${SquibView.version.url}" target="_blank">${SquibView.version.url}</a>`;
      
      // Demo 1: Basic Diff View
      const editor1 = new SquibView('#editor1', {
        initialContent: `# Welcome to SquibView Diff Demo

This is the initial content. Try editing this text to see the diff functionality in action.

## Features
- Live editing
- Revision history
- Source diffs
- Multiple content types

Make some changes and click "Show Diff" to see the differences!`,
        initialView: 'split'
      });

      function updateRevisionInfo(editor, infoElementId) {
        const revCount = editor.revisionManager.getRevisionCount();
        const currentIndex = editor.revisionManager.getCurrentIndex();
        document.getElementById(infoElementId).textContent = 
          `Current revision: ${currentIndex}, Total revisions: ${revCount}`;
      }

      updateRevisionInfo(editor1, 'revisionInfo1');
      
      document.getElementById('showDiff1').addEventListener('click', () => {
        try {
          const diffHTML = editor1.getSourceDiffHTML();
          document.getElementById('diffView1').innerHTML = diffHTML;
        } catch (e) {
          document.getElementById('diffView1').innerHTML = `<p style="color: red;">Error: ${e.message}</p>`;
        }
      });
      
      document.getElementById('clearDiff1').addEventListener('click', () => {
        document.getElementById('diffView1').innerHTML = '';
      });
      
      document.getElementById('addContent1').addEventListener('click', () => {
        editor1.setContent(editor1.getContent() + '\\n\\nAdded content at ' + new Date().toLocaleTimeString());
        updateRevisionInfo(editor1, 'revisionInfo1');
      });

      // Demo 2: Custom Styling
      const editor2 = new SquibView('#editor2', {
        initialContent: `# Custom Styled Diff

This demo shows how you can customize the appearance of diffs using custom CSS classes.

Try making some edits and see the different styling applied to the diff view.`,
        initialView: 'split'
      });
      
      document.getElementById('showDiff2').addEventListener('click', () => {
        const showLineNumbers = document.getElementById('lineNumbers2').checked;
        const customClasses = {
          container: 'custom-diff-container',
          line: 'custom-line',
          added: 'custom-added',
          removed: 'custom-removed',
          unchanged: 'custom-unchanged'
        };
        
        try {
          const diffHTML = editor2.getSourceDiffHTML({ 
            showLineNumbers,
            cssClasses: customClasses 
          });
          document.getElementById('diffView2').innerHTML = diffHTML;
        } catch (e) {
          document.getElementById('diffView2').innerHTML = `<p style="color: red;">Error: ${e.message}</p>`;
        }
      });
      
      document.getElementById('clearDiff2').addEventListener('click', () => {
        document.getElementById('diffView2').innerHTML = '';
      });

      // Demo 3: Revision Selection
      const editor3 = new SquibView('#editor3', {
        initialContent: 'Initial content for revision comparison demo.',
        initialView: 'split'
      });
      
      function populateRevisionSelects() {
        const revCount = editor3.revisionManager.getRevisionCount();
        const fromSelect = document.getElementById('fromRevision');
        const toSelect = document.getElementById('toRevision');
        
        fromSelect.innerHTML = '<option value="-1">Initial</option>';
        toSelect.innerHTML = '<option value="-1">Initial</option>';
        
        for (let i = 0; i < revCount; i++) {
          fromSelect.innerHTML += `<option value="${i}">Revision ${i}</option>`;
          toSelect.innerHTML += `<option value="${i}">Revision ${i}</option>`;
        }
        
        // Set default selection
        if (revCount > 0) {
          fromSelect.value = revCount > 1 ? (revCount - 2).toString() : '-1';
          toSelect.value = (revCount - 1).toString();
        }
      }
      
      document.getElementById('populateRevisions').addEventListener('click', () => {
        const contents = [
          'First revision: Added introduction',
          'Second revision: Added more details and examples',
          'Third revision: Fixed typos and improved formatting',
          'Fourth revision: Added conclusion and final thoughts'
        ];
        
        contents.forEach((content, index) => {
          setTimeout(() => {
            editor3.setContent(content);
            if (index === contents.length - 1) {
              setTimeout(populateRevisionSelects, 100);
            }
          }, index * 100);
        });
      });
      
      document.getElementById('compareDiff').addEventListener('click', () => {
        const fromIndex = parseInt(document.getElementById('fromRevision').value);
        const toIndex = parseInt(document.getElementById('toRevision').value);
        
        try {
          const diffHTML = editor3.getSourceDiffHTML({ fromIndex, toIndex });
          document.getElementById('diffView3').innerHTML = diffHTML;
        } catch (e) {
          document.getElementById('diffView3').innerHTML = `<p style="color: red;">Error: ${e.message}</p>`;
        }
      });

      // Demo 4: Programmatic API
      const editor4 = new SquibView('#editor4', {
        initialContent: 'Content for API demonstration.',
        initialView: 'src'
      });
      
      document.getElementById('getDiffData').addEventListener('click', () => {
        try {
          const diffData = editor4.getSourceDiff();
          document.getElementById('diffData').textContent = JSON.stringify(diffData, null, 2);
        } catch (e) {
          document.getElementById('diffData').textContent = `Error: ${e.message}`;
        }
      });
      
      document.getElementById('getDiffHTML').addEventListener('click', () => {
        try {
          const diffHTML = editor4.getSourceDiffHTML();
          // Show HTML as text for inspection
          document.getElementById('diffData').textContent = diffHTML;
        } catch (e) {
          document.getElementById('diffData').textContent = `Error: ${e.message}`;
        }
      });
      
      document.getElementById('makeChanges4').addEventListener('click', () => {
        editor4.setContent(editor4.getContent() + '\\nChange made at ' + new Date().toLocaleTimeString());
      });

      // Demo 5: Events
      const editor5 = new SquibView('#editor5', {
        initialContent: 'Content for event handling demo.',
        initialView: 'split'
      });
      
      const eventLog = [];
      
      function logEvent(eventName, data) {
        eventLog.push({
          timestamp: new Date().toLocaleTimeString(),
          event: eventName,
          data: data
        });
        
        const logElement = document.getElementById('eventLog');
        logElement.textContent = eventLog.map(entry => 
          `[${entry.timestamp}] ${entry.event}: ${JSON.stringify(entry.data, null, 2)}`
        ).join('\\n\\n');
        logElement.scrollTop = logElement.scrollHeight;
      }
      
      // Listen for diff events
      editor5.events.on('diff:computed', (data) => {
        logEvent('diff:computed', data);
      });
      
      editor5.events.on('diff:displayed', (data) => {
        logEvent('diff:displayed', data);
      });
      
      document.getElementById('showDiff5').addEventListener('click', () => {
        try {
          const diffHTML = editor5.getSourceDiffHTML();
          document.getElementById('diffView5').innerHTML = diffHTML;
        } catch (e) {
          document.getElementById('diffView5').innerHTML = `<p style="color: red;">Error: ${e.message}</p>`;
        }
      });
      
      document.getElementById('clearEvents').addEventListener('click', () => {
        eventLog.length = 0;
        document.getElementById('eventLog').textContent = 'Event log cleared. Make some changes and show diff to see events.';
      });
      
      // Add some initial content changes to editor5
      setTimeout(() => {
        editor5.setContent(editor5.getContent() + '\\nAdded line for demo.');
      }, 500);
      
      // Auto-populate revision selects for demo 3
      populateRevisionSelects();
    }
  </script>
  
  <!-- Custom CSS for demo 2 -->
  <style>
    .custom-diff-container {
      font-family: 'Courier New', monospace;
      border: 2px solid #4a90e2;
      border-radius: 8px;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }
    
    .custom-line {
      padding: 2px 0;
    }
    
    .custom-line.custom-added {
      background-color: #d4edda !important;
      border-left: 4px solid #28a745;
    }
    
    .custom-line.custom-removed {
      background-color: #f8d7da !important;
      border-left: 4px solid #dc3545;
    }
    
    .custom-line.custom-unchanged {
      background-color: transparent;
    }
  </style>
</body>
</html>